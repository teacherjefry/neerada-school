<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada School Management System</title>
    <!-- Tailwind CSS (Requires Internet) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons (Requires Internet) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts (Requires Internet) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-serif { font-family: 'Playfair Display', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Toast Styles */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        .toast { padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; display: flex; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); color: white; min-width: 300px; transform: translateX(100%); transition: transform 0.3s ease-out; }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        .toast.info { background-color: #3B82F6; }

        /* File Upload Preview */
        .image-preview { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; border: 1px solid #cbd5e1; margin-top: 10px; background-color: #f8fafc; }
        
        /* Logo Styling */
        #sidebar-logo-container img { height: 40px; width: 40px; background: white; padding: 2px; border-radius: 50%; object-fit: cover; }
        
        /* Sidebar Placeholder */
        #sidebar-logo-placeholder { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; }

        /* Mobile Menu Animation */
        #public-mobile-menu { transition: transform 0.3s ease-in-out; }
        #public-mobile-menu.hidden { transform: translateY(-100%); }
        #public-mobile-menu:not(.hidden) { transform: translateY(0); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-col hidden md:flex transition-all duration-300 shadow-xl z-20" id="sidebar">
        <div class="h-16 flex items-center px-6 border-b border-slate-700" id="sidebar-header">
            <div id="sidebar-logo-container" class="flex items-center">
                <!-- Circular White Placeholder -->
                <div id="sidebar-logo-placeholder">
                    <i class="ph ph-graduation-cap text-2xl text-blue-600"></i>
                </div>
                <!-- Logo img injected here via JS if uploaded -->
                <span class="font-bold text-xl tracking-tight">Neerada School</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1 px-3">
                <li>
                    <button onclick="neeradaApp.navigate('dashboard')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-squares-four text-xl mr-3 group-hover:text-blue-400"></i>
                        Dashboard
                    </button>
                </li>
                <li>
                    <button onclick="neeradaApp.navigate('administration')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-buildings text-xl mr-3 group-hover:text-blue-400"></i>
                        Administration
                    </button>
                </li>
                <li>
                    <button onclick="neeradaApp.navigate('teachers')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-chalkboard-teacher text-xl mr-3 group-hover:text-blue-400"></i>
                        Teachers
                    </button>
                </li>
                <!-- Moved Students Tab Here -->
                <li>
                    <button onclick="neeradaApp.navigate('students')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-student text-xl mr-3 group-hover:text-blue-400"></i>
                        Students
                    </button>
                </li>
                <li>
                    <button onclick="neeradaApp.navigate('staff')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-users text-xl mr-3 group-hover:text-blue-400"></i>
                        Staff
                    </button>
                </li>
                <li>
                    <button onclick="neeradaApp.navigate('classes')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-books text-xl mr-3 group-hover:text-blue-400"></i>
                        Classes
                    </button>
                </li>
                <li>
                    <button onclick="neeradaApp.navigate('settings')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-gear text-xl mr-3 group-hover:text-blue-400"></i>
                        Settings
                    </button>
                </li>
                <li class="mt-4 pt-4 border-t border-slate-700">
                    <button onclick="neeradaApp.navigate('home')" class="nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                        <i class="ph ph-globe text-xl mr-3 group-hover:text-emerald-400"></i>
                        View Website
                    </button>
                </li>
            </ul>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">A</div>
                <div>
                    <p class="text-sm font-medium">Admin User</p>
                    <p class="text-xs text-slate-400">Principal</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Header -->
        <header id="main-header" class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10">
            <button class="md:hidden text-slate-600 p-2 rounded-lg hover:bg-slate-100" onclick="toggleSidebar()">
                <i class="ph ph-list text-2xl"></i>
            </button>
            <h2 id="page-title" class="text-xl font-semibold text-slate-800 ml-2 md:ml-0">Dashboard</h2>
            <div class="flex items-center gap-4">
                <div class="hidden md:block text-sm text-slate-500" id="current-date"></div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
            <!-- Content injected via JS -->
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-slate-200 py-3 px-6 text-center text-sm text-slate-500">
            &copy; Neerada School <span id="footer-year"></span>. All rights reserved.
        </footer>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-40 backdrop-blur-sm transition-opacity opacity-0"></div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 pointer-events-auto transform scale-95 transition-all duration-200 opacity-0" id="login-modal-content">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ph ph-lock-key text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Admin Access</h3>
                <p class="text-slate-500 text-sm mb-6">Enter password to access dashboard</p>
                
                <form onsubmit="neeradaApp.processLogin(event)">
                    <input type="password" id="login-password" placeholder="Password (****)" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:border-blue-500 text-center tracking-widest mb-4 transition-colors" autofocus>
                    <div class="flex gap-2">
                        <button type="button" onclick="neeradaApp.closeLoginModal()" class="flex-1 px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancel</button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-all hover:shadow-lg transform active:scale-95">Login</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Generic Form Modal -->
    <div id="form-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 pointer-events-auto transform scale-95 transition-all duration-200 opacity-0" id="form-modal-content">
            <div class="flex justify-between items-center p-6 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">Add Entry</h3>
                <button onclick="ui.closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="dynamic-form" class="space-y-4">
                    <!-- Form fields injected here -->
                </form>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end gap-3">
                <button onclick="ui.closeModal()" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                <button id="modal-save-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-all hover:shadow-lg transform active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <!-- Teacher Detail View Modal (Floating Window) -->
    <div id="view-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center pointer-events-none">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 pointer-events-auto transform scale-95 transition-all duration-200 opacity-0 relative overflow-hidden" id="view-modal-content">
            <button onclick="ui.closeViewModal()" class="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 transition-colors">
                <i class="ph ph-x text-xl"></i>
            </button>
            <div id="view-modal-body">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Utils & Config ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Helper to compress images before converting to Base64 (fixes "upload not working" due to 1MB Firestore limit)
        // INCREASED COMPRESSION to ensure files save correctly
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // Aggressive compression: Max 500px to ensure < 1MB
                    const MAX_WIDTH = 500;
                    const MAX_HEIGHT = 500;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    // Compress to JPEG 50% quality for small string size
                    resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                };
                img.onerror = (e) => reject(e);
            };
            reader.onerror = error => reject(error);
        });

        // ---------------------------------------------------------------
        // FIREBASE CONFIGURATION
        // ---------------------------------------------------------------
        let firebaseConfig = {
            apiKey: "AIzaSyDlzTfWGTOrEnYEYib6aB74IPBGGLuTn6k",
            authDomain: "neerada-school.firebaseapp.com",
            projectId: "neerada-school",
            storageBucket: "neerada-school.firebasestorage.app",
            messagingSenderId: "841887574795",
            appId: "1:841887574795:web:8f2b4120ca23ea81fc500e"
        };

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        }

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neerada-school-public';

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        // --- Database Service (Firestore) ---
        class DBService {
            constructor() {
                this.basePath = ['artifacts', appId, 'public', 'data']; 
            }

            async connect() {
                if (!auth.currentUser) {
                    await initAuth();
                }
            }

            async getAll(collectionName) {
                try {
                    const ref = collection(db, ...this.basePath, collectionName);
                    const snapshot = await getDocs(ref);
                    // FIX: Spread data first, then overwrite id with doc.id to ensure we have the actual document ID
                    // irrespective of what garbage 'id' field might be saved inside the data.
                    return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                } catch (e) {
                    console.error("Error fetching data:", e);
                    return [];
                }
            }

            // Fixed ADD method: Always remove 'id' before adding to avoid confusion
            async add(collectionName, item) {
                const ref = collection(db, ...this.basePath, collectionName);
                const dataToSave = { ...item };
                if (dataToSave.id !== undefined) delete dataToSave.id;
                await addDoc(ref, dataToSave);
            }

            async set(collectionName, docId, data) {
                const ref = doc(db, ...this.basePath, collectionName, docId);
                await setDoc(ref, data);
            }

            // Fixed UPDATE method: Throw error if no ID to prevent bad paths
            async update(collectionName, item) {
                const id = item.id;
                if (!id) throw new Error("Cannot update: Missing document ID");
                const data = { ...item };
                delete data.id; 
                const ref = doc(db, ...this.basePath, collectionName, id);
                await updateDoc(ref, data);
            }

            async delete(collectionName, id) {
                if (!id) throw new Error("Cannot delete: Missing document ID");
                const ref = doc(db, ...this.basePath, collectionName, id);
                await deleteDoc(ref);
            }
        }

        // --- UI Manager ---
        class UIManager {
            constructor() {
                this.contentArea = $('#main-content');
                this.pageTitle = $('#page-title');
                this.mainHeader = $('#main-header');
                this.sidebar = $('#sidebar');
                this.modal = $('#form-modal');
                this.modalOverlay = $('#modal-overlay');
                this.modalContent = $('#form-modal-content');
                this.loginModal = $('#login-modal');
                this.loginModalContent = $('#login-modal-content');
                this.viewModal = $('#view-modal');
                this.viewModalContent = $('#view-modal-content');
                this.viewModalBody = $('#view-modal-body');
                this.toastContainer = $('#toast-container');
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let iconClass = type === 'success' ? 'ph-check-circle' : type === 'error' ? 'ph-warning-circle' : 'ph-info';
                
                toast.innerHTML = `<i class="ph ${iconClass} text-2xl mr-3"></i><span class="font-medium">${message}</span>`;
                this.toastContainer.appendChild(toast);
                requestAnimationFrame(() => toast.classList.add('show'));
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateLogo(logoData) {
                if (!logoData) return;
                const container = $('#sidebar-logo-container');
                if (container) {
                    // Check if img exists inside container, else replace placeholder
                    let img = container.querySelector('img');
                    
                    if (img) {
                        img.src = logoData;
                    } else {
                        // Find placeholder and replace it
                        const placeholder = container.querySelector('#sidebar-logo-placeholder');
                        if (placeholder) {
                            img = document.createElement('img');
                            img.src = logoData;
                            img.className = "mr-3 object-cover";
                            img.style.height = "40px";
                            img.style.width = "40px";
                            img.style.backgroundColor = "white";
                            img.style.padding = "2px";
                            img.style.borderRadius = "50%";
                            container.insertBefore(img, placeholder);
                            placeholder.remove();
                        }
                    }
                }
            }

            renderPublicNavbar() {
                // Circular White Background for Logo
                const logoHtml = neeradaApp.settings.logo ? 
                    `<div class="bg-white rounded-full overflow-hidden p-1 mr-2 shadow-md w-10 h-10 flex items-center justify-center shrink-0"><img src="${neeradaApp.settings.logo}" class="w-full h-full object-cover rounded-full"></div>` : 
                    `<div class="bg-white rounded-full overflow-hidden p-1 mr-2 shadow-md w-10 h-10 flex items-center justify-center shrink-0"><i class="ph ph-graduation-cap text-blue-600 text-xl"></i></div>`;

                return `
                    <nav class="fixed w-full z-50 transition-all duration-300 bg-white/95 backdrop-blur-md border-b border-emerald-100/50 shadow-sm">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-20 md:h-24">
                                <div class="flex items-center gap-1 group cursor-pointer" onclick="neeradaApp.navigate('home')">
                                    ${logoHtml}
                                    <div class="flex flex-col">
                                        <span class="font-serif font-bold text-xl md:text-2xl tracking-wide text-slate-800 leading-none">NEERADA</span>
                                        <span class="text-[10px] md:text-xs font-bold tracking-[0.2em] text-emerald-600 uppercase">School</span>
                                    </div>
                                </div>
                                <div class="hidden md:flex items-center gap-8 text-sm font-semibold text-slate-600">
                                    <button onclick="neeradaApp.navigate('home')" class="hover:text-emerald-600 transition-colors">Home</button>
                                    <button onclick="neeradaApp.navigate('public-admin')" class="hover:text-emerald-600 transition-colors">Administration</button>
                                    <button onclick="neeradaApp.navigate('public-teachers')" class="hover:text-emerald-600 transition-colors">Teachers</button>
                                    <button onclick="neeradaApp.navigate('public-staff')" class="hover:text-emerald-600 transition-colors">Staff</button>
                                    <button onclick="neeradaApp.navigate('public-students')" class="hover:text-emerald-600 transition-colors">Students</button>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="neeradaApp.login()" class="bg-slate-900 hover:bg-emerald-600 text-white px-4 md:px-8 py-2 md:py-3 rounded-full text-xs md:text-sm font-medium transition-all shadow-xl hover:shadow-emerald-500/30 transform hover:-translate-y-0.5">
                                        ${neeradaApp.isLoggedIn ? 'Dashboard' : 'Login'}
                                    </button>
                                </div>
                            </div>
                            <div class="md:hidden overflow-x-auto hide-scrollbar pb-3 -mx-4 px-4 flex gap-6 text-sm font-medium text-slate-600 border-t border-slate-100 pt-3">
                                <button onclick="neeradaApp.navigate('home')" class="whitespace-nowrap hover:text-emerald-600 flex-shrink-0">Home</button>
                                <button onclick="neeradaApp.navigate('public-admin')" class="whitespace-nowrap hover:text-emerald-600 flex-shrink-0">Administration</button>
                                <button onclick="neeradaApp.navigate('public-teachers')" class="whitespace-nowrap hover:text-emerald-600 flex-shrink-0">Teachers</button>
                                <button onclick="neeradaApp.navigate('public-staff')" class="whitespace-nowrap hover:text-emerald-600 flex-shrink-0">Staff</button>
                                <button onclick="neeradaApp.navigate('public-students')" class="whitespace-nowrap hover:text-emerald-600 flex-shrink-0">Students</button>
                            </div>
                        </div>
                    </nav>
                `;
            }

            setupPublicView() {
                this.sidebar.classList.add('hidden');
                this.sidebar.classList.remove('md:flex');
                this.mainHeader.style.display = 'none';
                this.contentArea.classList.remove('p-4', 'md:p-8');
            }

            renderHome() {
                this.setupPublicView();
                this.contentArea.innerHTML = `
                    <div class="min-h-full flex flex-col bg-white fade-in font-sans scroll-smooth">
                        ${this.renderPublicNavbar()}
                        <div class="relative h-screen flex items-center justify-center overflow-hidden bg-slate-900">
                             <div class="absolute inset-0 z-0">
                                <img src="https://images.unsplash.com/photo-1541829070764-84a7d30dd3f3?q=80&w=2069&auto=format&fit=crop" class="w-full h-full object-cover scale-105 animate-[pulse_10s_ease-in-out_infinite]" alt="School Campus" onerror="this.src='https://placehold.co/1920x1080?text=Neerada+School+Campus';">
                                <div class="absolute inset-0 bg-gradient-to-b from-slate-900/70 via-slate-900/50 to-slate-900/80 mix-blend-multiply"></div>
                            </div>
                            <div class="relative z-10 max-w-7xl mx-auto px-6 text-center pt-20">
                                <h1 class="text-5xl md:text-7xl lg:text-8xl font-black text-white mb-8 leading-tight tracking-tight drop-shadow-2xl">
                                    <span class="block text-white drop-shadow-md mb-2">NEERADA</span> 
                                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-300 via-emerald-300 to-green-200 font-serif italic">SCHOOL</span>
                                </h1>
                                <p class="text-slate-200 text-xl md:text-2xl mb-12 max-w-2xl mx-auto leading-relaxed font-light border-l-4 border-emerald-500 pl-6 text-left md:text-center md:border-l-0 md:border-t-2 md:pt-6 md:border-emerald-500/50">
                                    Cultivating Excellence. Rooted in Values. Empowering the next generation of leaders in Laos.
                                </p>
                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="document.getElementById('academics').scrollIntoView({behavior: 'smooth'})" class="bg-emerald-600 text-white px-8 py-4 rounded-full font-bold hover:bg-emerald-700 transition-all shadow-lg hover:shadow-emerald-500/40 transform hover:-translate-y-1">
                                        Discover Our Programs
                                    </button>
                                </div>
                            </div>
                            <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 animate-bounce text-white/50">
                                <i class="ph ph-arrow-down text-3xl"></i>
                            </div>
                        </div>
                        <div id="academics" class="bg-slate-50 py-24 px-6">
                            <div class="max-w-7xl mx-auto">
                                <div class="text-center mb-16">
                                    <span class="text-emerald-600 font-bold tracking-widest uppercase text-sm mb-2 block">Our Programs</span>
                                    <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-6 font-serif">Academic Pathways</h2>
                                    <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-emerald-500 mx-auto rounded-full"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all group">
                                        <div class="h-48 overflow-hidden relative">
                                            <img src="https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?q=80&w=2000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                            <div class="absolute bottom-4 left-4 text-white">
                                                <h3 class="text-xl font-bold">Kindergarten</h3>
                                            </div>
                                        </div>
                                        <div class="p-8">
                                            <p class="text-slate-600 mb-6 line-clamp-3">A nurturing environment focusing on play-based learning.</p>
                                            <button onclick="neeradaApp.navigate('public-teachers', {step: 'dept', campus: 'Chommany', dept: 'Kindergarten'})" class="text-emerald-600 font-bold hover:text-emerald-700 flex items-center gap-2">Meet the Teachers <i class="ph ph-arrow-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all group">
                                        <div class="h-48 overflow-hidden relative">
                                            <img src="https://images.unsplash.com/photo-1588072432836-e10032774350?q=80&w=2000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                            <div class="absolute bottom-4 left-4 text-white">
                                                <h3 class="text-xl font-bold">Primary School</h3>
                                            </div>
                                        </div>
                                        <div class="p-8">
                                            <p class="text-slate-600 mb-6 line-clamp-3">Building strong foundations in core subjects.</p>
                                            <button onclick="neeradaApp.navigate('public-teachers', {step: 'dept', campus: 'Sibounheuang', dept: 'Primary'})" class="text-blue-600 font-bold hover:text-blue-700 flex items-center gap-2">Meet the Teachers <i class="ph ph-arrow-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all group">
                                        <div class="h-48 overflow-hidden relative">
                                            <!-- UPDATED IMAGE: Science Lab/Classroom for Secondary -->
                                            <img src="https://images.unsplash.com/photo-1576267423445-b2e0074d68a4?q=80&w=2000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                            <div class="absolute bottom-4 left-4 text-white">
                                                <h3 class="text-xl font-bold">Secondary School</h3>
                                            </div>
                                        </div>
                                        <div class="p-8">
                                            <p class="text-slate-600 mb-6 line-clamp-3">Preparing students for higher education and beyond.</p>
                                            <button onclick="neeradaApp.navigate('public-teachers', {step: 'dept', campus: 'Sibounheuang', dept: 'Secondary'})" class="text-emerald-600 font-bold hover:text-emerald-700 flex items-center gap-2">Meet the Teachers <i class="ph ph-arrow-right"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderPublicAdmin(members) {
                this.setupPublicView();
                const canEdit = neeradaApp.isLoggedIn;
                
                // Helper to create card HTML
                const createCard = (m) => `
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden group hover:shadow-2xl transition-all border border-slate-100 flex flex-col items-center p-8 text-center relative w-full md:w-[350px]">
                        ${canEdit ? `
                            <div class="absolute top-4 right-4 flex gap-2 z-10 bg-white/80 backdrop-blur rounded-full p-1 shadow-sm">
                                <button onclick="neeradaApp.openEditModal('org_members', '${m.id}')" class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50"><i class="ph ph-pencil-simple text-lg"></i></button>
                                <button onclick="neeradaApp.deleteItem('org_members', '${m.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50"><i class="ph ph-trash text-lg"></i></button>
                            </div>
                        ` : ''}
                        <div class="w-64 h-64 mb-6 relative">
                            <div class="w-full h-full rounded-2xl overflow-hidden border-4 border-white shadow-lg bg-slate-100">
                                ${m.image ? `<img src="${m.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">` : `<div class="w-full h-full flex flex-col items-center justify-center text-slate-400 bg-slate-50"><i class="ph ph-user text-6xl mb-2"></i><span class="text-sm">No Photo</span></div>`}
                            </div>
                        </div>
                        <h3 class="font-serif font-bold text-2xl text-slate-900 mb-1">${m.name}</h3>
                        <div class="inline-block px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-bold tracking-wider uppercase mb-4">${m.role}</div>
                        
                        <div class="w-full space-y-2 border-t border-slate-100 pt-4 mt-auto">
                            ${m.contact ? `
                                <div class="flex items-center justify-center gap-2 text-slate-600 text-sm">
                                    <i class="ph ph-address-book text-emerald-500 text-lg"></i>
                                    <span>${m.contact}</span>
                                </div>
                            ` : '<span class="text-slate-400 italic text-sm">Contact info unavailable</span>'}
                        </div>
                    </div>
                `;

                // Categorize members
                const hierarchy = {
                    line1: [], // Honorary Chairwoman
                    line2: [], // School Director, Special Assistant
                    line3: [], // Vice Principals
                    line4: [], // Academic Heads
                    others: [] // Everyone else
                };

                members.forEach(m => {
                    const r = (m.role || '').toLowerCase();
                    if (r.includes('honorary chairwoman')) hierarchy.line1.push(m);
                    else if (r.includes('school director') && !r.includes('assistant')) hierarchy.line2.unshift(m); // Director first
                    else if (r.includes('special assistant')) hierarchy.line2.push(m); // Assistant second
                    else if (r.includes('vice principal')) hierarchy.line3.push(m);
                    else if (r.includes('academic head')) hierarchy.line4.push(m);
                    else hierarchy.others.push(m);
                });

                // Function to render a row
                const renderRow = (list) => {
                    if (list.length === 0) return '';
                    return `<div class="flex flex-wrap justify-center gap-6 md:gap-10 w-full mb-8 md:mb-12">${list.map(m => createCard(m)).join('')}</div>`;
                };

                let contentHtml = '';
                if (members.length === 0) {
                    contentHtml = `<div class="col-span-full text-center text-slate-400 py-20 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">Organization chart is being updated.</div>`;
                } else {
                    contentHtml = `
                        ${renderRow(hierarchy.line1)}
                        ${renderRow(hierarchy.line2)}
                        ${renderRow(hierarchy.line3)}
                        ${renderRow(hierarchy.line4)}
                        ${renderRow(hierarchy.others)}
                    `;
                }

                this.contentArea.innerHTML = `
                    <div class="min-h-full flex flex-col bg-slate-50 fade-in font-sans">
                        ${this.renderPublicNavbar()}
                        <div class="pt-32 pb-20 px-6 max-w-7xl mx-auto w-full">
                            <div class="text-center mb-16">
                                <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4 font-serif">Administration</h2>
                                <div class="w-24 h-1.5 bg-gradient-to-r from-blue-500 to-emerald-500 mx-auto rounded-full mb-6"></div>
                                <p class="text-slate-600 text-lg max-w-2xl mx-auto">Meet the visionary leaders guiding Neerada School towards excellence.</p>
                                ${canEdit ? `<button onclick="neeradaApp.openAddModal('org_members')" class="mt-8 bg-emerald-600 text-white px-8 py-3 rounded-full text-sm font-bold shadow-lg hover:bg-emerald-700 transition-all flex items-center gap-2 mx-auto"><i class="ph ph-plus text-lg"></i> Add Administrator</button>` : ''}
                            </div>
                            <div class="flex flex-col items-center">
                                ${contentHtml}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderPublicTeachers(viewState = { step: 'campus', campus: null, dept: null }, teachers = []) {
                this.setupPublicView();
                let content = '';
                if (viewState.step === 'campus') {
                    content = `
                        <div class="text-center mb-16"><h2 class="text-4xl md:text-5xl font-bold text-slate-900 font-serif mb-4">Our Faculty</h2></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 max-w-5xl mx-auto">
                            <div onclick="neeradaApp.navigate('public-teachers', { step: 'dept', campus: 'Sibounheuang' })" class="bg-white rounded-3xl shadow-xl hover:shadow-2xl transition-all cursor-pointer group overflow-hidden relative h-80">
                                <img src="https://images.unsplash.com/photo-1562774053-701939374585?q=80&w=1000&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-8 text-white"><h3 class="text-3xl font-bold font-serif mb-2">Sibounheuang Campus</h3></div>
                            </div>
                            <div onclick="neeradaApp.navigate('public-teachers', { step: 'dept', campus: 'Chommany' })" class="bg-white rounded-3xl shadow-xl hover:shadow-2xl transition-all cursor-pointer group overflow-hidden relative h-80">
                                <img src="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?q=80&w=1000&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-8 text-white"><h3 class="text-3xl font-bold font-serif mb-2">Chommany Campus</h3></div>
                            </div>
                        </div>
                    `;
                } else if (viewState.step === 'dept') {
                    // Update Secondary Image here as well to keep consistency
                    const depts = [{ name: 'Kindergarten', img: 'https://images.unsplash.com/photo-1587654780291-39c9404d746b?q=80&w=600&auto=format&fit=crop' }, { name: 'Primary', img: 'https://images.unsplash.com/photo-1509062522246-3755977927d7?q=80&w=600&auto=format&fit=crop' }, { name: 'Secondary', img: 'https://images.unsplash.com/photo-1576267423445-b2e0074d68a4?q=80&w=600&auto=format&fit=crop' }, { name: 'English', img: 'https://images.unsplash.com/photo-1543269865-cbf427effbad?q=80&w=600&auto=format&fit=crop' }];
                    const cards = depts.map(d => `<div onclick="neeradaApp.navigate('public-teachers', { step: 'list', campus: '${viewState.campus}', dept: '${d.name}' })" class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all cursor-pointer overflow-hidden group h-64 relative"><img src="${d.img}" class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"><div class="absolute inset-0 bg-slate-900/50"></div><div class="absolute inset-0 flex flex-col items-center justify-center text-white"><h3 class="text-2xl font-bold font-serif mb-2">${d.name}</h3></div></div>`).join('');
                    content = `<div class="max-w-7xl mx-auto"><button onclick="neeradaApp.navigate('public-teachers')" class="mb-8 text-slate-500 hover:text-slate-900 flex items-center gap-2 font-medium transition-colors"><i class="ph ph-arrow-left"></i> Back</button><div class="text-center mb-16"><h2 class="text-4xl font-bold text-slate-900 font-serif">Select Department</h2></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">${cards}</div></div>`;
                } else if (viewState.step === 'list') {
                    const filtered = teachers.filter(t => t.campus === viewState.campus && t.department === viewState.dept);
                    let listHtml = filtered.length === 0 ? `<div class="col-span-full text-center py-20 text-slate-400">No teachers found.</div>` : filtered.map(t => `<div onclick="neeradaApp.showTeacherDetails('${t.id}')" class="bg-white rounded-2xl shadow-xl overflow-hidden cursor-pointer p-6 text-center transform hover:-translate-y-1"><div class="w-64 h-[320px] mb-6 relative rounded-xl overflow-hidden bg-slate-50 mx-auto">${t.image ? `<img src="${t.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex flex-col items-center justify-center text-slate-400"><i class="ph ph-chalkboard-teacher text-6xl"></i></div>`}</div><h3 class="font-serif font-bold text-2xl text-slate-900">${t.name}</h3></div>`).join('');
                    content = `<div class="max-w-7xl mx-auto"><button onclick="neeradaApp.navigate('public-teachers', { step: 'dept', campus: '${viewState.campus}' })" class="mb-8 text-slate-500 hover:text-slate-900 flex items-center gap-2 font-medium"><i class="ph ph-arrow-left"></i> Back</button><div class="text-center mb-16"><h2 class="text-4xl md:text-5xl font-bold text-slate-900 font-serif">${viewState.dept} Teachers</h2></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 justify-items-center">${listHtml}</div></div>`;
                }
                this.contentArea.innerHTML = `<div class="min-h-full flex flex-col bg-slate-50 fade-in font-sans">${this.renderPublicNavbar()}<div class="pt-32 pb-20 px-6 w-full">${content}</div></div>`;
            }

            async renderPublicStaff() {
                this.setupPublicView();
                const canEdit = neeradaApp.isLoggedIn;
                const members = await neeradaApp.db.getAll('staff');
                let cards = members.map(m => `<div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 flex flex-col items-center p-8 text-center relative">${canEdit ? `<div class="absolute top-4 right-4 flex gap-2 z-10 bg-white/80 p-1 rounded-full"><button onclick="neeradaApp.openEditModal('staff', '${m.id}')" class="text-blue-600 p-2"><i class="ph ph-pencil-simple"></i></button><button onclick="neeradaApp.deleteItem('staff', '${m.id}')" class="text-red-500 p-2"><i class="ph ph-trash"></i></button></div>` : ''}<div class="w-64 h-64 mb-6 relative"><div class="w-full h-full rounded-2xl overflow-hidden bg-slate-100">${m.image ? `<img src="${m.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex flex-col items-center justify-center text-slate-400"><i class="ph ph-user text-6xl"></i></div>`}</div></div><h3 class="font-serif font-bold text-2xl text-slate-900">${m.name}</h3><div class="inline-block px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs font-bold uppercase mb-4">${m.role}</div></div>`).join('');
                if(members.length === 0) cards = `<div class="col-span-full text-center text-slate-400 py-20">Staff directory is being updated.</div>`;
                this.contentArea.innerHTML = `<div class="min-h-full flex flex-col bg-slate-50 fade-in font-sans">${this.renderPublicNavbar()}<div class="pt-32 pb-20 px-6 max-w-7xl mx-auto w-full"><div class="text-center mb-16"><h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4 font-serif">Support Staff</h2>${canEdit ? `<button onclick="neeradaApp.openAddModal('staff')" class="mt-8 bg-blue-600 text-white px-8 py-3 rounded-full text-sm font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2 mx-auto"><i class="ph ph-plus text-lg"></i> Add Staff Member</button>` : ''}</div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">${cards}</div></div></div>`;
            }

            async renderPublicStudents() {
                this.setupPublicView();
                const students = await neeradaApp.db.getAll('students');
                
                // --- NEW HIERARCHY: Campus -> Dept -> Year ---
                const hierarchy = {};
                students.forEach(s => {
                    const c = s.campus || 'Unassigned';
                    const d = s.department || 'General';
                    const y = s.school_year || 'Current';
                    
                    if (!hierarchy[c]) hierarchy[c] = {};
                    if (!hierarchy[c][d]) hierarchy[c][d] = {};
                    if (!hierarchy[c][d][y]) hierarchy[c][d][y] = [];
                    hierarchy[c][d][y].push(s);
                });

                let content = '';
                const campuses = Object.keys(hierarchy).sort();

                if (campuses.length === 0) {
                    content = `<div class="text-center py-20 text-slate-400 bg-white rounded-3xl border-2 border-dashed border-slate-200">No student records found.</div>`;
                } else {
                    content = campuses.map(campus => `
                        <div class="mb-12">
                            <h2 class="text-3xl font-bold text-slate-800 border-b-2 border-blue-500 inline-block mb-8 pb-2">${campus} Campus</h2>
                            ${Object.keys(hierarchy[campus]).sort().map(dept => `
                                <div class="mb-8 ml-4">
                                    <h3 class="text-xl font-bold text-emerald-600 mb-4 flex items-center gap-2"><i class="ph ph-buildings"></i> ${dept}</h3>
                                    ${Object.keys(hierarchy[campus][dept]).sort().reverse().map(year => `
                                        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 mb-4 overflow-hidden">
                                            <div class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                                <h4 class="font-bold text-slate-700">School Year: ${year}</h4>
                                                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">${hierarchy[campus][dept][year].length} Students</span>
                                            </div>
                                            <div class="p-6 hidden"> <!-- Hidden by default for cleaner look, toggle to see -->
                                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                    ${hierarchy[campus][dept][year].map(s => `
                                                        <div class="flex items-center p-3 bg-white border border-slate-100 rounded-lg hover:shadow-md transition-shadow">
                                                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-sm mr-3 shrink-0">${s.name.charAt(0)}</div>
                                                            <div>
                                                                <p class="font-medium text-slate-800 text-sm truncate w-32">${s.name}</p>
                                                                <p class="text-xs text-slate-400">${s.grade}</p>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                }

                this.contentArea.innerHTML = `
                    <div class="min-h-full flex flex-col bg-slate-50 fade-in font-sans">
                        ${this.renderPublicNavbar()}
                        <div class="pt-32 pb-20 px-6 max-w-7xl mx-auto w-full">
                            <div class="text-center mb-16">
                                <h2 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4 font-serif">Our Students</h2>
                                <p class="text-slate-600">Click on a School Year to view the student list.</p>
                            </div>
                            <div class="max-w-5xl mx-auto">
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSettings(currentSettings) {
                this.sidebar.classList.remove('hidden');
                this.sidebar.classList.add('md:flex');
                this.mainHeader.style.display = 'flex';
                this.contentArea.classList.add('p-4', 'md:p-8');
                this.pageTitle.textContent = "Settings";
                const logoSrc = currentSettings.logo || '';
                this.contentArea.innerHTML = `
                    <div class="max-w-2xl mx-auto space-y-8 fade-in">
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-xl font-bold text-slate-800 mb-6 pb-4 border-b border-slate-100">School Configuration</h3>
                            <form onsubmit="neeradaApp.saveSettings(event)" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-2">School Logo</label>
                                    <div class="flex items-center gap-6">
                                        <!-- Circular Settings Preview -->
                                        <div class="w-24 h-24 rounded-full bg-slate-100 border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden relative">
                                            ${logoSrc ? `<img src="${logoSrc}" id="settings-logo-preview" class="w-full h-full object-cover">` : `<i class="ph ph-image text-3xl text-slate-400" id="settings-logo-icon"></i>`}
                                        </div>
                                        <div class="flex-1">
                                            <input type="file" id="settings-logo-input" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="neeradaApp.previewSettingsLogo(this)">
                                            <p class="mt-2 text-xs text-slate-500">Upload a square image (PNG/JPG). Max 1MB.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="pt-6 border-t border-slate-100 flex justify-end">
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-md flex items-center gap-2"><i class="ph ph-floppy-disk text-lg"></i> Save Changes</button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-red-50 p-8 rounded-xl shadow-sm border border-red-200">
                            <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center gap-2"><i class="ph ph-warning-diamond"></i> Danger Zone</h3>
                            <p class="text-red-600 mb-6 text-sm">This area is for emergency maintenance. If you have corrupted data or need to reset the system, use the button below. <strong>This action cannot be undone.</strong></p>
                            <button onclick="neeradaApp.wipeAllData()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-md transition-all active:scale-95 flex items-center gap-2 w-full justify-center sm:w-auto">
                                <i class="ph ph-trash text-xl"></i> Delete ALL Data (Reset System)
                            </button>
                        </div>
                    </div>
                `;
            }

            renderDashboard(stats) {
                this.sidebar.classList.add('hidden');
                this.sidebar.classList.add('md:flex');
                this.mainHeader.style.display = 'flex';
                this.contentArea.classList.add('p-4', 'md:p-8');
                this.pageTitle.textContent = "Dashboard";
                this.contentArea.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-6 fade-in"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p class="text-slate-500 text-sm font-medium">Students</p><h3 class="text-3xl font-bold text-slate-800 mt-1">${stats.students}</h3></div><div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center"><i class="ph ph-student text-2xl"></i></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p class="text-slate-500 text-sm font-medium">Teachers</p><h3 class="text-3xl font-bold text-slate-800 mt-1">${stats.teachers}</h3></div><div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center"><i class="ph ph-chalkboard-teacher text-2xl"></i></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p class="text-slate-500 text-sm font-medium">Staff</p><h3 class="text-3xl font-bold text-slate-800 mt-1">${stats.staff}</h3></div><div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center"><i class="ph ph-users text-2xl"></i></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><div><p class="text-slate-500 text-sm font-medium">Classes</p><h3 class="text-3xl font-bold text-slate-800 mt-1">${stats.classes}</h3></div><div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center"><i class="ph ph-books text-2xl"></i></div></div></div><div class="mt-8 bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 rounded-xl shadow-lg relative overflow-hidden"><div class="relative z-10"><h3 class="text-2xl font-bold mb-2">Welcome Back!</h3><p class="text-slate-300 mb-6">Manage data or update the public website content from here.</p><div class="flex gap-3"><button onclick="neeradaApp.navigate('students')" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg text-sm font-medium">Manage Students</button><button onclick="neeradaApp.navigate('administration')" class="bg-white/10 hover:bg-white/20 text-white px-5 py-2 rounded-lg text-sm font-medium">Manage Admin</button><button onclick="neeradaApp.logout()" class="bg-red-500/20 hover:bg-red-500/40 text-red-100 px-5 py-2 rounded-lg text-sm font-medium">Logout</button></div></div></div>`;
            }

            renderTable(title, columns, data, type) {
                this.sidebar.classList.remove('hidden');
                this.sidebar.classList.add('md:flex');
                this.mainHeader.style.display = 'flex';
                this.contentArea.classList.add('p-4', 'md:p-8');
                this.pageTitle.textContent = title;
                
                let rowsHtml = data.length === 0 ? 
                    `<tr><td colspan="${columns.length + 1}" class="text-center py-8 text-slate-400">No records.</td></tr>` : 
                    data.map(item => `<tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">${columns.map(col => { if (col.key === 'image') { const imgSrc = item[col.key]; return `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600"><div class="w-10 h-12 rounded-md bg-slate-100 overflow-hidden border border-slate-200">${imgSrc ? `<img src="${imgSrc}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="ph ph-user text-xl"></i></div>'}</div></td>`; } return `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${item[col.key] || '-'}</td>` }).join('')}<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="neeradaApp.openEditModal('${type}', '${item.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="ph ph-pencil-simple"></i> Edit</button><button onclick="neeradaApp.deleteItem('${type}', '${item.id}')" class="text-red-500 hover:text-red-700"><i class="ph ph-trash"></i> Delete</button></td></tr>`).join('');

                this.contentArea.innerHTML = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col fade-in"><div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl"><input type="text" placeholder="Search..." class="pl-4 pr-4 py-2 border border-slate-300 rounded-lg text-sm w-64" onkeyup="neeradaApp.filterTable(this.value)"><button onclick="neeradaApp.openAddModal('${type}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2"><i class="ph ph-plus-circle text-lg"></i> Add New</button></div><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50 border-b border-slate-200"><tr>${columns.map(c => `<th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase">${c.label}</th>`).join('')}<th class="px-6 py-3 text-right text-xs font-semibold text-slate-500 uppercase">Actions</th></tr></thead><tbody class="bg-white divide-y divide-slate-100">${rowsHtml}</tbody></table></div></div>`;
            }

            openModal(title, fields, saveCallback) {
                $('#modal-title').textContent = title;
                const form = $('#dynamic-form');
                form.innerHTML = fields.map(field => {
                    if (field.type === 'hidden') return `<input type="hidden" name="${field.name}" value="${field.value || ''}">`;
                    if (field.type === 'select') return `<div><label class="block text-sm font-medium text-slate-700 mb-1">${field.label}</label><select name="${field.name}" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500">${field.options.map(opt => `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select></div>`;
                    if (field.type === 'file') return `<div><label class="block text-sm font-medium text-slate-700 mb-1">${field.label}</label><input type="file" name="${field.name}" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">${field.value ? `<img src="${field.value}" class="image-preview">` : ''}</div>`;
                    return `<div><label class="block text-sm font-medium text-slate-700 mb-1">${field.label}</label><input type="${field.type}" name="${field.name}" value="${field.value || ''}" class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none focus:border-blue-500" ${field.required ? 'required' : ''}></div>`;
                }).join('');
                
                $('#modal-save-btn').onclick = async (e) => {
                    e.preventDefault();
                    if(form.checkValidity()) {
                        const btn = $('#modal-save-btn');
                        const originalText = btn.textContent;
                        btn.textContent = "Saving...";
                        btn.disabled = true;
                        try {
                            const formData = new FormData(form);
                            const data = Object.fromEntries(formData.entries());
                            const fileInput = form.querySelector('input[type="file"]');
                            if (fileInput && fileInput.files[0]) {
                                data.image = await fileToBase64(fileInput.files[0]);
                            } else {
                                const existingImg = fields.find(f => f.name === 'image');
                                if(existingImg && existingImg.value) data.image = existingImg.value;
                            }
                            if (data['image'] instanceof File) delete data['image'];
                            await saveCallback(data);
                            this.closeModal();
                        } catch (err) { console.error("Save error:", err); alert("Error saving data: " + err.message); } 
                        finally { btn.textContent = originalText; btn.disabled = false; }
                    } else { form.reportValidity(); }
                };
                this.modalOverlay.classList.remove('hidden');
                this.modal.classList.remove('hidden');
                setTimeout(() => { this.modalOverlay.classList.remove('opacity-0'); this.modalContent.classList.remove('opacity-0', 'scale-95'); this.modalContent.classList.add('scale-100'); }, 10);
            }

            closeModal() {
                this.modalOverlay.classList.add('opacity-0');
                this.modalContent.classList.add('opacity-0', 'scale-95');
                this.modalContent.classList.remove('scale-100');
                setTimeout(() => { this.modalOverlay.classList.add('hidden'); this.modal.classList.add('hidden'); $('#dynamic-form').innerHTML = ''; }, 200);
            }

            openLoginModal() {
                this.modalOverlay.classList.remove('hidden');
                this.loginModal.classList.remove('hidden');
                $('#login-password').value = '';
                setTimeout(() => { this.modalOverlay.classList.remove('opacity-0'); this.loginModalContent.classList.remove('opacity-0', 'scale-95'); this.loginModalContent.classList.add('scale-100'); $('#login-password').focus(); }, 10);
            }

            closeLoginModal() {
                this.modalOverlay.classList.add('opacity-0');
                this.loginModalContent.classList.add('opacity-0', 'scale-95');
                this.loginModalContent.classList.remove('scale-100');
                setTimeout(() => { this.modalOverlay.classList.add('hidden'); this.loginModal.classList.add('hidden'); }, 200);
            }

            openViewModal(content) {
                this.viewModalBody.innerHTML = content;
                $('#modal-overlay').classList.remove('hidden');
                this.viewModal.classList.remove('hidden');
                setTimeout(() => { $('#modal-overlay').classList.remove('opacity-0'); this.viewModalContent.classList.remove('opacity-0', 'scale-95'); this.viewModalContent.classList.add('scale-100'); }, 10);
            }

            closeViewModal() {
                $('#modal-overlay').classList.add('opacity-0');
                this.viewModalContent.classList.add('opacity-0', 'scale-95');
                this.viewModalContent.classList.remove('scale-100');
                setTimeout(() => { $('#modal-overlay').classList.add('hidden'); this.viewModal.classList.add('hidden'); this.viewModalBody.innerHTML = ''; }, 200);
            }
        }

        // --- Global Interactions ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // --- Application Logic ---
        class SchoolApp {
            constructor() {
                this.db = new DBService();
                this.ui = new UIManager();
                this.currentView = 'home';
                this.dataCache = [];
                this.isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                this.settings = { logo: null };
            }

            async init() {
                try {
                    await this.db.connect();
                    const settingsDocs = await this.db.getAll('settings');
                    if (settingsDocs.length > 0) {
                        this.settings = settingsDocs[0];
                    }
                    this.ui.updateLogo(this.settings.logo);
                    this.navigate(this.isLoggedIn ? 'dashboard' : 'home');
                    const dEl = $('#current-date');
                    if(dEl) dEl.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                } catch (err) {
                    console.error(err);
                    this.ui.showToast("Database error", "error");
                }
            }

            login() {
                if(this.isLoggedIn) { this.navigate('dashboard'); return; }
                this.ui.openLoginModal();
            }

            processLogin(e) {
                e.preventDefault();
                const pwd = $('#login-password').value;
                if (pwd === '0000') {
                    this.isLoggedIn = true;
                    localStorage.setItem('isLoggedIn', 'true');
                    this.ui.closeLoginModal();
                    this.ui.showToast("Logged in successfully", "success");
                    this.navigate('dashboard');
                } else {
                    this.ui.showToast("Incorrect password", "error");
                    $('#login-password').value = '';
                    $('#login-password').focus();
                }
            }

            closeLoginModal() {
                this.ui.closeLoginModal();
            }
            
            logout() {
                this.isLoggedIn = false;
                localStorage.setItem('isLoggedIn', 'false');
                this.ui.showToast("Logged out", "info");
                this.navigate('home');
            }

            async navigate(view, params = {}) {
                this.currentView = view;
                $$('.nav-item').forEach(btn => {
                    btn.classList.remove('bg-slate-800', 'text-white');
                    btn.classList.add('text-slate-300');
                });
                const activeBtn = Array.from($$('.nav-item')).find(b => b.innerText.toLowerCase().includes(view.split('-')[0]));
                if(activeBtn) { activeBtn.classList.add('bg-slate-800', 'text-white'); activeBtn.classList.remove('text-slate-300'); }

                if(window.innerWidth < 768) $('#sidebar').classList.add('hidden');

                switch (view) {
                    case 'home': this.ui.renderHome(); break;
                    case 'public-admin':
                        const members = await this.db.getAll('org_members');
                        this.ui.renderPublicAdmin(members);
                        break;
                    case 'public-teachers':
                        const teachersList = await this.db.getAll('teachers');
                        const viewState = { step: params.step || 'campus', campus: params.campus, dept: params.dept };
                        this.ui.renderPublicTeachers(viewState, teachersList);
                        break;
                    case 'public-staff': this.ui.renderPublicStaff(); break;
                    case 'public-students': this.ui.renderPublicStudents(); break;
                    case 'dashboard':
                        if(!this.isLoggedIn) { this.navigate('home'); return; }
                        const [s, t, c, st] = await Promise.all([
                            this.db.getAll('students'), 
                            this.db.getAll('teachers'), 
                            this.db.getAll('classes'),
                            this.db.getAll('staff')
                        ]);
                        this.ui.renderDashboard({ students: s.length, teachers: t.length, classes: c.length, staff: st.length });
                        break;
                    case 'students': this.loadData('students', [
                        { key: 'name', label: 'Name' }, { key: 'grade', label: 'Grade' }, { key: 'campus', label: 'Campus' }, { key: 'school_year', label: 'Year' }
                    ]); break;
                    case 'teachers': this.loadData('teachers', [
                        { key: 'image', label: 'Photo' }, { key: 'name', label: 'Name' }, { key: 'campus', label: 'Campus' }, { key: 'department', label: 'Dept' }
                    ]); break;
                    case 'staff': this.loadData('staff', [
                        { key: 'image', label: 'Photo' }, { key: 'name', label: 'Name' }, { key: 'role', label: 'Role' }, { key: 'contact', label: 'Contact' }
                    ]); break;
                    case 'administration': this.loadData('org_members', [
                        { key: 'image', label: 'Photo' }, { key: 'name', label: 'Name' }, { key: 'role', label: 'Role' }, { key: 'contact', label: 'Contact' }
                    ]); break;
                    case 'classes': this.loadData('classes', [
                        { key: 'name', label: 'Class' }, { key: 'room', label: 'Room' }, { key: 'schedule', label: 'Time' }
                    ]); break;
                    case 'settings':
                        if(!this.isLoggedIn) { this.navigate('home'); return; }
                        this.ui.renderSettings(this.settings);
                        break;
                }
            }

            async loadData(type, cols) {
                if(!this.isLoggedIn) { this.navigate('home'); return; }
                const data = await this.db.getAll(type);
                this.dataCache = data;
                
                // Sorting Logic for Administration in Dashboard Table
                if (type === 'org_members') {
                    const getPriority = (role) => {
                        const r = (role || '').toLowerCase();
                        if (r.includes('honorary chairwoman')) return 1;
                        if (r.includes('school director') && !r.includes('assistant')) return 2;
                        if (r.includes('special assistant')) return 3;
                        if (r.includes('vice principal')) return 4;
                        if (r.includes('academic head')) return 5;
                        return 6;
                    };
                    data.sort((a, b) => getPriority(a.role) - getPriority(b.role));
                }

                const title = type === 'org_members' ? 'Administration' : type.charAt(0).toUpperCase() + type.slice(1);
                this.ui.renderTable(`Manage ${title}`, cols, data, type);
            }

            async previewSettingsLogo(input) {
                if (input.files && input.files[0]) {
                    try {
                        const base64 = await fileToBase64(input.files[0]);
                        const preview = document.getElementById('settings-logo-preview');
                        if (preview) preview.src = base64;
                        else {
                            const icon = document.getElementById('settings-logo-icon');
                            if(icon) {
                                const img = document.createElement('img');
                                img.src = base64;
                                img.id = 'settings-logo-preview';
                                img.className = "w-full h-full object-cover";
                                icon.replaceWith(img);
                            }
                        }
                    } catch (e) {
                        alert("File too large or invalid.");
                    }
                }
            }

            async saveSettings(e) {
                e.preventDefault();
                const input = document.getElementById('settings-logo-input');
                let newLogo = this.settings.logo;
                if (input && input.files && input.files[0]) {
                    newLogo = await fileToBase64(input.files[0]);
                }
                const newSettings = { ...this.settings, logo: newLogo };
                await this.db.set('settings', 'school_config', newSettings);
                this.settings = newSettings;
                this.ui.updateLogo(newLogo);
                this.ui.showToast('Settings saved successfully', 'success');
            }

            async wipeAllData() {
                if(!confirm(" CRITICAL WARNING \n\nAre you sure you want to DELETE ALL DATA?\n\nThis will permanently remove every Student, Teacher, Staff member, and Admin record from the database.\n\nThis cannot be undone.")) return;
                
                const btn = document.querySelector('button[onclick="neeradaApp.wipeAllData()"]');
                if(btn) {
                    btn.disabled = true;
                    btn.textContent = "Deleting everything... Please wait...";
                }

                this.ui.showToast("Starting system reset...", "info");
                const collections = ['students', 'teachers', 'staff', 'org_members'];
                
                try {
                    let totalDeleted = 0;
                    for (const col of collections) {
                        const docs = await this.db.getAll(col);
                        for (const doc of docs) {
                            if (doc.id) {
                                await this.db.delete(col, doc.id);
                                totalDeleted++;
                            }
                        }
                    }
                    this.ui.showToast(`System Reset Complete. Deleted ${totalDeleted} records.`, "success");
                    // Refresh current view
                    setTimeout(() => window.location.reload(), 1500);
                } catch (e) {
                    console.error(e);
                    this.ui.showToast("Error wiping data: " + e.message, "error");
                    if(btn) {
                        btn.disabled = false;
                        btn.textContent = "Delete ALL Data (Reset System)";
                    }
                }
            }

            // CRUD Configs
            getFieldsFor(type, item = {}) {
                if (type === 'students') return [
                    { name: 'name', label: 'Full Name', type: 'text', value: item.name, required: true },
                    { name: 'grade', label: 'Grade', type: 'text', value: item.grade, required: true },
                    { name: 'campus', label: 'Campus', type: 'select', options: ['Sibounheuang', 'Chommany'], value: item.campus || 'Sibounheuang' },
                    { name: 'department', label: 'Department', type: 'select', options: ['Kindergarten', 'Primary', 'Secondary', 'English'], value: item.department || 'Primary' },
                    { name: 'school_year', label: 'School Year (e.g., 2024-2025)', type: 'text', value: item.school_year || '2024-2025', required: true },
                    { name: 'parent', label: 'Parent Name', type: 'text', value: item.parent, required: true },
                    { name: 'phone', label: 'Phone', type: 'tel', value: item.phone, required: true }
                ];
                if (type === 'teachers') return [
                    { name: 'name', label: 'Full Name', type: 'text', value: item.name, required: true },
                    { name: 'grade_level', label: 'Grade Level', type: 'text', value: item.grade_level, required: true },
                    { name: 'section', label: 'Classroom/Section', type: 'text', value: item.section, required: true },
                    { name: 'campus', label: 'Campus', type: 'select', options: ['Sibounheuang', 'Chommany'], value: item.campus || 'Sibounheuang' },
                    { name: 'department', label: 'Department', type: 'select', options: ['Kindergarten', 'Primary', 'Secondary', 'English'], value: item.department || 'Primary' },
                    { name: 'email', label: 'Email', type: 'email', value: item.email, required: true },
                    { name: 'phone', label: 'Phone', type: 'tel', value: item.phone, required: true },
                    { name: 'image', label: 'Photo', type: 'file', value: item.image, required: false }
                ];
                if (type === 'classes') return [
                    { name: 'name', label: 'Class Name', type: 'text', value: item.name, required: true },
                    { name: 'room', label: 'Room', type: 'text', value: item.room, required: true },
                    { name: 'schedule', label: 'Schedule', type: 'text', value: item.schedule, required: true }
                ];
                if (type === 'org_members') return [
                    { name: 'name', label: 'Name', type: 'text', value: item.name, required: true },
                    { name: 'role', label: 'Role/Title', type: 'text', value: item.role, required: true },
                    { name: 'contact', label: 'Contact/Email', type: 'text', value: item.contact, required: false },
                    { name: 'image', label: 'Photo', type: 'file', value: item.image, required: false }
                ];
                if (type === 'staff') return [
                    { name: 'name', label: 'Name', type: 'text', value: item.name, required: true },
                    { name: 'role', label: 'Role/Position', type: 'text', value: item.role, required: true },
                    { name: 'contact', label: 'Contact/Email', type: 'text', value: item.contact, required: true },
                    { name: 'image', label: 'Photo', type: 'file', value: item.image, required: false }
                ];
                return [];
            }

            openAddModal(type) {
                const fields = this.getFieldsFor(type);
                fields.push({ name: 'id', label: '', type: 'hidden', value: '' });
                this.ui.openModal(`Add ${type === 'org_members' ? 'Admin' : type.slice(0, -1)}`, fields, async (data) => {
                    await this.db.add(type, data);
                    this.ui.showToast('Added successfully', 'success');
                    if(this.currentView === 'public-admin' && type === 'org_members') this.navigate('public-admin');
                    else if(this.currentView === 'public-staff' && type === 'staff') this.navigate('public-staff');
                    else this.navigate(type === 'org_members' ? 'administration' : type); 
                });
            }

            async openEditModal(type, id) {
                const list = await this.db.getAll(type);
                const item = list.find(i => i.id === id);
                if(!item) return;
                const fields = this.getFieldsFor(type, item);
                
                this.ui.openModal(`Edit ${type === 'org_members' ? 'Admin' : type.slice(0, -1)}`, fields, async (data) => {
                    data.id = id; // FIX: Explicitly set ID to prevent 'missing document ID' error
                    await this.db.update(type, data);
                    this.ui.showToast('Updated successfully', 'success');
                     if(this.currentView === 'public-admin' && type === 'org_members') this.navigate('public-admin');
                     else if(this.currentView === 'public-staff' && type === 'staff') this.navigate('public-staff');
                    else this.navigate(type === 'org_members' ? 'administration' : type); 
                });
            }

            async deleteItem(type, id) {
                if(confirm('Delete this record?')) {
                    await this.db.delete(type, id);
                    this.ui.showToast('Deleted', 'info');
                     if(this.currentView === 'public-admin' && type === 'org_members') this.navigate('public-admin');
                     else if(this.currentView === 'public-staff' && type === 'staff') this.navigate('public-staff');
                    else this.navigate(type === 'org_members' ? 'administration' : type); 
                }
            }

            filterTable(query) {
                if(!query) { this.navigate(this.currentView); return; }
                const lower = query.toLowerCase();
                const filtered = this.dataCache.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(lower)));
                let cols = [];
                if(this.currentView==='students') cols=[{key:'name',label:'Name'},{key:'grade',label:'Grade'},{key:'campus',label:'Campus'},{key:'school_year',label:'Year'}];
                if(this.currentView==='teachers') cols=[{key:'image',label:'Photo'},{key:'name',label:'Name'},{key:'campus',label:'Campus'},{key:'department',label:'Dept'}];
                if(this.currentView==='staff') cols=[{key:'image',label:'Photo'},{key:'name',label:'Name'},{key:'role',label:'Role'},{key:'contact',label:'Contact'}];
                if(this.currentView==='administration') cols=[{key:'image',label:'Photo'},{key:'name',label:'Name'},{key:'role',label:'Role'},{key:'contact',label:'Contact'}];
                if(this.currentView==='classes') cols=[{key:'name',label:'Class'},{key:'room',label:'Room'},{key:'schedule',label:'Time'}];
                this.ui.renderTable(this.ui.pageTitle.textContent, cols, filtered, this.currentView);
                document.querySelector('input[type="text"]').value = query;
                document.querySelector('input[type="text"]').focus();
            }
            async showTeacherDetails(id) {
                const teachers = await this.db.getAll('teachers');
                const t = teachers.find(i => i.id === id);
                if (!t) return;
                const content = `<div class="relative"><div class="h-72 w-full bg-slate-200 relative">${t.image ? `<img src="${t.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="ph ph-chalkboard-teacher text-6xl"></i></div>`}<div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div><div class="absolute bottom-4 left-6 text-white"><h2 class="text-3xl font-bold font-serif mb-1">${t.name}</h2><p class="text-emerald-300 font-medium tracking-wide uppercase text-sm">${t.department} Teacher</p></div></div><div class="p-6 space-y-4 bg-white"><div class="flex items-center gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl shadow-sm"><i class="ph ph-buildings"></i></div><div><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Campus</p><p class="text-slate-800 font-bold">${t.campus}</p></div></div><div class="flex items-center gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl shadow-sm"><i class="ph ph-chalkboard"></i></div><div><p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Classroom</p><p class="text-slate-800 font-bold text-lg">${t.grade_level || '-'} <span class="text-slate-400">/</span> ${t.section || '-'}</p></div></div><div class="grid grid-cols-1 gap-3"><div class="p-3 bg-slate-50 rounded-xl border border-slate-100 flex items-center gap-3"><i class="ph ph-phone text-purple-500 text-lg"></i><div><p class="text-[10px] text-slate-400 font-bold uppercase">Phone</p><p class="text-slate-800 font-medium text-sm break-all">${t.phone}</p></div></div><div class="p-3 bg-slate-50 rounded-xl border border-slate-100 flex items-center gap-3"><i class="ph ph-envelope text-orange-500 text-lg"></i><div><p class="text-[10px] text-slate-400 font-bold uppercase">Email</p><p class="text-slate-800 font-medium text-sm break-all">${t.email}</p></div></div></div><div class="pt-4"><button onclick="ui.closeViewModal()" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-emerald-600 transition-all shadow-lg">Close Details</button></div></div></div>`;
                this.ui.openViewModal(content);
            }
        }

        const neeradaApp = new SchoolApp();
        const ui = neeradaApp.ui;
        window.neeradaApp = neeradaApp;
        window.ui = ui;
        
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        };

        window.addEventListener('DOMContentLoaded', () => neeradaApp.init());
    </script>
</body>
</html>
